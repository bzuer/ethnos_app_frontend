{% extends "base.html" %}

{% block title %}{{ work.title if work else 'Obra' }} - ANTROPOTECA{% endblock %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">{{ work.title if work else 'Obra não encontrada' }}</h1>
    {% if work and work.subtitle %}
    <p class="item-subtitle">{{ work.subtitle }}</p>
    {% endif %}
</header>

{% if work %}

<section aria-labelledby="data-title">
    <h2 class="title-section" id="data-title">Dados Bibliográficos</h2>
    <table class="data-table">
        <tbody>
            {% if author_details %}
                {% set authors = author_details | selectattr("role", "equalto", "AUTHOR") | list %}
                {% set editors = author_details | selectattr("role", "equalto", "EDITOR") | list %}
                
                {% if authors %}
                <tr>
                    <th>AUTOR(ES)</th>
                    <td class="field-value">
                        <span class="author">
                            {% for author in authors %}
                                {% if author.person_id %}
                                    <a href="/person/{{ author.person_id }}/works" class="action-link">{{ author.name }}</a>
                                {% else %}
                                    <span>{{ author.name }}</span>
                                {% endif %}
                                {% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </td>
                </tr>
                {% endif %}
                
                {% if affiliations_list %}
                <tr>
                    <th>AFILIAÇÃO(ÕES)</th>
                    <td class="field-value">
                        <span class="affiliations">
                            {% for affiliation in affiliations_list %}
                                {{ affiliation }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </td>
                </tr>
                {% endif %}
                
                {% if editors %}
                <tr>
                    <th>EDITOR(ES)</th>
                    <td class="field-value">
                        <span class="editor">
                            {% for editor in editors %}
                                {% if editor.person_id %}
                                    <a href="/person/{{ editor.person_id }}/works" class="action-link">{{ editor.name }}</a>
                                {% else %}
                                    <span>{{ editor.name }}</span>
                                {% endif %}
                                {% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </td>
                </tr>
                {% endif %}
            {% elif work.display_authors %}
            <tr>
                <th>AUTOR(ES)</th>
                <td class="field-value">
                    <span class="author">
                        {% for author in work.display_authors %}
                            {{ author }}
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span>
                </td>
            </tr>
            {% endif %}
            
            <tr>
                <th>ANO</th>
                <td class="field-value">{{ work.publication_year or 'Não informado' }}</td>
            </tr>
            
            {% if work.formatted_type %}
            <tr>
                <th>TIPO</th>
                <td class="field-value">{{ work.formatted_type }}</td>
            </tr>
            {% endif %}
            
            {% if venue_details %}
            <tr>
                <th>PERIÓDICO</th>
                <td class="field-value">
                    <a href="/venue/{{ venue_details.id }}" class="action-link">
                        {{ venue_details.name }}
                    </a>
                </td>
            </tr>
            {% endif %}
            
            {% if venue_details and venue_details.issn %}
            <tr>
                <th>ISSN</th>
                <td class="field-value">{{ venue_details.issn }}</td>
            </tr>
            {% endif %}
            
            {% if venue_details and venue_details.eissn %}
            <tr>
                <th>E-ISSN</th>
                <td class="field-value">{{ venue_details.eissn }}</td>
            </tr>
            {% endif %}
            
            {% if work.publisher and work.publisher.name %}
            <tr>
                <th>EDITORA</th>
                <td class="field-value">
                    {{ work.publisher.name }}
                    {% if work.publisher.country %} ({{ work.publisher.country }}){% endif %}
                </td>
            </tr>
            {% elif venue_details and venue_details.publisher_name %}
            <tr>
                <th>EDITORA</th>
                <td class="field-value">{{ venue_details.publisher_name }}</td>
            </tr>
            {% endif %}
            
            {% if work.doi_url %}
            <tr>
                <th>DOI</th>
                <td class="field-value">
                    <a href="{{ work.doi_url }}" target="_blank" class="action-link">
                        {{ work.temp_doi or work.doi }}
                    </a>
                </td>
            </tr>
            {% endif %}
            
            {% if work.language %}
            <tr>
                <th>IDIOMA</th>
                <td class="field-value">{{ work.language|upper }}</td>
            </tr>
            {% endif %}
            
            {% if metrics_data %}
            {% if metrics_data.citation_metrics and metrics_data.citation_metrics.total_citations_received and metrics_data.citation_metrics.total_citations_received > 0 %}
            <tr>
                <th>CITAÇÕES</th>
                <td class="field-value">{{ metrics_data.citation_metrics.total_citations_received }}</td>
            </tr>
            {% endif %}
            
            {% if metrics_data.file_metrics and metrics_data.file_metrics.total_files and metrics_data.file_metrics.total_files > 0 %}
            <tr>
                <th>ARQUIVOS</th>
                <td class="field-value">{{ metrics_data.file_metrics.total_files }}</td>
            </tr>
            {% endif %}
            
            {% if metrics_data.file_metrics and metrics_data.file_metrics.total_size_mb %}
            <tr>
                <th>TAMANHO TOTAL</th>
                <td class="field-value">{{ "%.1f"|format(metrics_data.file_metrics.total_size_mb) }} MB</td>
            </tr>
            {% endif %}
            {% elif work.metrics %}
            {% if work.metrics.citation_count and work.metrics.citation_count > 0 %}
            <tr>
                <th>CITAÇÕES</th>
                <td class="field-value">{{ work.metrics.citation_count }}</td>
            </tr>
            {% endif %}
            
            {% if work.metrics.has_files and work.metrics.file_count and work.metrics.file_count > 0 %}
            <tr>
                <th>ARQUIVOS</th>
                <td class="field-value">{{ work.metrics.file_count }}</td>
            </tr>
            {% endif %}
            {% endif %}
            
            <tr>
                <th>ADICIONADO EM</th>
                <td class="field-value">{{ work.created_at[:10] if work.created_at else 'Não informado' }}</td>
            </tr>
            
            {% if files_data %}
            {% for file in files_data %}
            {% if file.identifiers and file.identifiers.md5 %}
            <tr>
                <th>MD5</th>
                <td class="field-value">
                    <code class="md5-code">{{ file.identifiers.md5 }}</code>
                </td>
            </tr>
            {% endif %}
            
            {% if file.file_info and file.file_info.format %}
            <tr>
                <th>FORMATO</th>
                <td class="field-value">{{ file.file_info.format }}</td>
            </tr>
            {% endif %}
            
            {% if file.file_info and file.file_info.pages and file.file_info.pages > 0 %}
            <tr>
                <th>PÁGINAS</th>
                <td class="field-value">{{ file.file_info.pages }}</td>
            </tr>
            {% endif %}
            
            {% if file.file_info and file.file_info.size_mb %}
            <tr>
                <th>TAMANHO</th>
                <td class="field-value">{{ "%.1f"|format(file.file_info.size_mb) }} MB</td>
            </tr>
            {% endif %}
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</section>

{% if work.abstract %}
<section aria-labelledby="abstract-title">
    <h2 class="title-section" id="abstract-title">Resumo</h2>
    <p class="field-value">{{ work.abstract }}</p>
</section>
{% endif %}

{% if similar_works %}
<section aria-labelledby="related-title">
    <h2 class="title-section" id="related-title">
        {% if show_references %}
            Referências Citadas
        {% else %}
            Obras Relacionadas
        {% endif %}
    </h2>
    <div class="similar-works">
        {% for related in similar_works %}
        <div class="similar-work">
            {% if related.id %}
            <a href="/works/{{ related.id }}" class="action-link">
                <strong>{{ related.title }}</strong>
            </a>
            {% else %}
            <strong>{{ related.title }}</strong>
            {% endif %}
            {% if related.authors %}
            <p class="similar-authors">{{ related.authors[:2]|join(', ') }}{% if related.authors|length > 2 %} et al.{% endif %}</p>
            {% endif %}
            {% if related.year %}
            <p class="similar-year">({{ related.year }})</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section aria-labelledby="tools-title" class="tools-section">
    <h2 class="title-section" id="tools-title">Ferramentas</h2>
    <div class="action-links tools-buttons">
        {% if work.doi_url %}
        <a href="{{ work.doi_url }}" target="_blank" class="action-btn btn-positive">Acessar via DOI</a>
        {% endif %}
        {% if files_data %}
        {% for file in files_data %}
        {% if file.identifiers and file.identifiers.md5 %}
        <a href="https://annas-archive.org/md5/{{ file.identifiers.md5 }}" target="_blank" class="action-btn btn-positive">Anna's Archive</a>
        {% endif %}
        {% endfor %}
        {% endif %}
        <button id="add-to-list-btn" class="action-btn btn-positive">Adicionar à Lista</button>
        <button id="share-btn" class="action-btn btn-positive" data-title="{{ work.title }}" data-url="{{ request.url }}">Compartilhar</button>
        <button id="print-btn" class="action-btn btn-positive">Imprimir</button>
    </div>
</section>

{% else %}
<section aria-labelledby="not-found">
    <h2 class="title-section" id="not-found">Obra não encontrada</h2>
    <p class="field-value">A obra solicitada não foi encontrada no sistema.</p>
    <a href="{{ url_for('home') }}" class="action-link">Voltar ao início</a>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/item-detail.min.js') }}?v=20250820-10"></script>
{% endblock %}
