const STORAGE_KEY="ethnos_app_personal_list";function initializePersonalList(){loadPersonalList(),setupExportFunctionality(),updateGlobalCounter(),setupEventHandlers()}function loadPersonalList(){const e=document.getElementById("personal-list-container"),t=document.getElementById("export-section"),a=document.getElementById("export-empty-message");if(!e)return;const n=getPersonalList();if(0===n.length)return e.innerHTML='\n            <div class="empty-state">\n                <p class="field-value">Sua lista pessoal est√° vazia.</p>\n                <p class="description">Adicione itens visitando as p√°ginas de detalhes dos trabalhos.</p>\n            </div>\n        ',t&&(t.style.display="none"),void(a&&(a.style.display="block"));t&&(t.style.display="block"),a&&(a.style.display="none");let o=`\n        <div class="list-header">\n            <p class="list-stats">\n                <span class="field-value">${n.length} ${1===n.length?"item":"itens"} na sua lista</span>\n                <span class="description">Adicionado${1===n.length?"":"s"} em ordem cronol√≥gica</span>\n            </p>\n        </div>\n    `;o+='\n        <table class="data-table personal-list-table" aria-label="Lista pessoal de trabalhos salvos">\n            <thead>\n                <tr>\n                    <th scope="col">T√çTULO</th>\n                    <th scope="col">AUTOR(ES)</th>\n                    <th scope="col">ANO</th>\n                    <th scope="col">A√á√ïES</th>\n                </tr>\n            </thead>\n            <tbody>\n    ';[...n].reverse().forEach(e=>{const t=formatAuthorsForDisplay(e.authors),a=escapeHtml(e.title||"T√≠tulo n√£o dispon√≠vel"),n=e.publication_year||"N/A";o+=`\n            <tr data-item-id="${e.id}">\n                <td class="field-value">\n                    <a href="/works/${e.id}" \n                       class="action-link" \n                       aria-label="Ver detalhes de ${a}">\n                        ${a}\n                    </a>\n                </td>\n                <td class="field-value">${escapeHtml(t)}</td>\n                <td class="field-value">${n}</td>\n                <td>\n                    <button type="button" \n                            class="action-btn btn-negative remove-from-list-btn" \n                            data-item-id="${e.id}"\n                            aria-label="Remover '${a}' da lista">\n                        Remover\n                    </button>\n                </td>\n            </tr>\n        `}),o+="</tbody></table>",e.innerHTML=o}function getPersonalList(){try{const e=localStorage.getItem(STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Error loading personal list:",e),[]}}function savePersonalList(e){try{return localStorage.setItem(STORAGE_KEY,JSON.stringify(e)),!0}catch(e){return console.error("Error saving personal list:",e),showTemporaryMessage("Erro ao salvar lista. Verifique o espa√ßo de armazenamento.","error"),!1}}function addToPersonalList(e){if(!e||!e.id||!e.title)return{success:!1,message:"Dados do item inv√°lidos"};const t=getPersonalList();if(t.some(t=>t.id===e.id))return{success:!1,message:"Item j√° est√° na sua lista"};const a={id:e.id,title:e.title,authors:e.authors,publication_year:e.publication_year,venue_name:e.venue_name,type:e.type,added_at:(new Date).toISOString()};return t.push(a),savePersonalList(t)?(updateGlobalCounter(),{success:!0,message:"Item adicionado √† sua lista"}):{success:!1,message:"Erro ao adicionar item"}}function removeFromList(e){const t=getPersonalList(),a=t.find(t=>t.id===e);if(!a)return void showTemporaryMessage("Item n√£o encontrado na lista","error");const n=t.filter(t=>t.id!==e);savePersonalList(n)&&(loadPersonalList(),updateGlobalCounter(),showTemporaryMessage(`"${a.title}" removido da lista`,"success"))}function clearAllItems(){0!==getPersonalList().length?confirm("Tem certeza que deseja limpar toda a sua lista? Esta a√ß√£o n√£o pode ser desfeita.")&&(localStorage.removeItem(STORAGE_KEY),loadPersonalList(),updateGlobalCounter(),showTemporaryMessage("Lista limpa com sucesso","success")):showTemporaryMessage("Sua lista j√° est√° vazia","info")}function setupEventHandlers(){document.addEventListener("click",function(e){const t=e.target;if(t.classList.contains("remove-from-list-btn")){const e=parseInt(t.dataset.itemId);return void(isNaN(e)||removeFromList(e))}(t.classList.contains("clear-all-btn")||"clear-all-btn"===t.id)&&clearAllItems()})}function setupExportFunctionality(){document.addEventListener("click",function(e){switch(e.target.id){case"export-txt-btn":exportABNT();break;case"export-bib-btn":exportBibTeX();break;case"export-ris-btn":exportRIS();break;case"export-json-btn":exportJSON()}})}function updateGlobalCounter(){const e=document.getElementById("reading-list-counter");if(e){const t=getPersonalList().length;e.textContent=t,e.style.display=t>0?"inline":"none"}window.updateReadingListCounter&&window.updateReadingListCounter()}function formatAuthorsForDisplay(e){return Array.isArray(e)?e.map(e=>e.full_name||e).join("; "):e||"Autor n√£o informado"}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showTemporaryMessage(e,t="info"){const a=document.createElement("div");a.className=`temporary-message temporary-message-${t}`,a.textContent=e,a.setAttribute("role","status"),a.setAttribute("aria-live","polite");const n={success:"var(--primary-blue)",error:"#dc3545",info:"var(--subtle-gray)"}[t]||"var(--subtle-gray)";Object.assign(a.style,{position:"fixed",top:"20px",right:"20px",background:n,color:"white",padding:"var(--spacing-sm) var(--spacing-md)",borderRadius:"4px",zIndex:"1000",fontFamily:"var(--mono)",fontSize:"12px",maxWidth:"300px",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"}),document.body.appendChild(a),setTimeout(()=>{a.parentNode&&(a.style.opacity="0",a.style.transition="opacity 0.3s ease-out",setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},300))},3e3)}async function fetchCompleteWorkData(e){if(0===e.length)return[];try{return(await Promise.all(e.map(async e=>{try{const t=await fetch(`${window.location.origin}/api/work/${e}/details`);if(t.ok){return await t.json()}return null}catch(t){return console.error(`Error fetching work ${e}:`,t),null}}))).filter(e=>null!==e)}catch(e){return console.error("Error fetching complete work data:",e),showTemporaryMessage("Erro ao buscar dados completos. Usando dados locais.","error"),[]}}async function exportABNT(){const e=getPersonalList();if(0===e.length)return void showTemporaryMessage("Sua lista est√° vazia. N√£o h√° nada para exportar.","info");showTemporaryMessage("Buscando dados completos...","info");const t=await fetchCompleteWorkData(e.map(e=>e.id));let a="";a+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n",a+="                 REFER√äNCIAS BIBLIOGR√ÅFICAS                    \\n",a+="                    FORMATO ABNT - NBR 6023                     \\n",a+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n\\n",a+="üìã INFORMA√á√ïES DA EXPORTA√á√ÉO:\\n",a+=`   ‚Ä¢ Data: ${(new Date).toLocaleDateString("pt-BR")} √†s ${(new Date).toLocaleTimeString("pt-BR")}\\n`,a+=`   ‚Ä¢ Total de refer√™ncias: ${e.length}\\n`,a+=`   ‚Ä¢ Dados completos obtidos: ${t.length}\\n`,a+="   ‚Ä¢ Fonte: Ethnos Academic Database\\n\\n",a+="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n",a+="                        REFER√äNCIAS\\n",a+="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n\\n",e.forEach((n,o)=>{const s=t.find(e=>e.id===n.id)||n;a+=`[${String(o+1).padStart(2,"0")}] `;let i="AUTOR N√ÉO INFORMADO";s.authors&&Array.isArray(s.authors)?i=s.authors.map((e,t)=>{let a=e.name||e.full_name||e;if(a&&a.includes(" ")){const e=a.trim().split(" ");a=`${e.pop().toUpperCase()}, ${e.join(" ")}`}else a=a.toUpperCase();return a}).join("; "):s.authors&&(i=s.authors.toUpperCase());const r=s.title||"T√≠tulo n√£o informado",l=s.subtitle?`: ${s.subtitle}`:"",c=s.publication?.year||s.year||"S.d.",p=s.venue?.name||s.venue_name||"",u=s.publisher?.name||s.publisher_name||"",d=s.publication?.volume||s.volume||"",m=s.publication?.issue||s.issue||"",h=s.publication?.pages||s.pages||"",g=s.doi||"",b=s.venue?.issn||"",f=s.work_type||s.type||"",_=s.language||"",v=s.publication?.open_access||s.open_access,y=s.publication?.peer_reviewed||s.peer_reviewed;a+=`${i}. `,a+=`${r}${l}. `,p&&(a+=`**${p}**, `,d&&(a+=`v. ${d}, `),m&&"None"!==m&&(a+=`n. ${m}, `)),(u&&p||u)&&(a+=`${u}, `),a+=`${c}.`,h&&(a+=` p. ${h}.`),g&&(a+=` Dispon√≠vel em: https://doi.org/${g}.`,a+=` Acesso em: ${(new Date).toLocaleDateString("pt-BR")}.`),a+="\\n";const $=[];if(f&&$.push(`Tipo: ${formatWorkType(f)}`),_&&"pt"!==_&&$.push(`Idioma: ${formatLanguage(_)}`),b&&$.push(`ISSN: ${b}`),y&&$.push("üîç Revisado por pares"),v&&$.push("üîì Acesso aberto"),$.length>0&&(a+=`     ‚ï∞‚îÄ ${$.join(" ‚Ä¢ ")}\\n`),s.abstract&&s.abstract.length>0){const e=s.abstract.length>200?s.abstract.substring(0,200)+"...":s.abstract;a+=`     üìù Resumo: ${e}\\n`}a+="\\n",o<e.length-1&&(a+="     ‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà\\n\\n")}),a+="\\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n",a+="                         ESTAT√çSTICAS\\n",a+="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n\\n";const n=e.length,o=t.filter(e=>e.abstract&&e.abstract.length>0).length,s=t.filter(e=>e.doi).length,i=t.filter(e=>e.publication?.open_access||e.open_access).length,r=t.filter(e=>e.publication?.peer_reviewed||e.peer_reviewed).length;a+=`üìä Total de refer√™ncias: ${n}\\n`,a+=`üìÑ Com resumo: ${o} (${Math.round(o/n*100)}%)\\n`,a+=`üîó Com DOI: ${s} (${Math.round(s/n*100)}%)\\n`,a+=`üîì Acesso aberto: ${i} (${Math.round(i/n*100)}%)\\n`,a+=`üîç Revisado por pares: ${r} (${Math.round(r/n*100)}%)\\n\\n`,a+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n",a+="     Gerado por Ethnos Academic Database ‚Ä¢ ethnos.app\\n",a+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê",downloadFile(a,`referencias-abnt-${(new Date).toISOString().split("T")[0]}.txt`,"text/plain"),showTemporaryMessage("Refer√™ncias ABNT exportadas com formata√ß√£o profissional","success")}function formatWorkType(e){return{ARTICLE:"Artigo",BOOK:"Livro",CHAPTER:"Cap√≠tulo",THESIS:"Tese/Disserta√ß√£o",CONFERENCE:"Artigo de Evento",REPORT:"Relat√≥rio",DATASET:"Dataset",OTHER:"Outro"}[e]||e}function formatLanguage(e){return{pt:"Portugu√™s",en:"Ingl√™s",es:"Espanhol",fr:"Franc√™s",de:"Alem√£o",it:"Italiano"}[e]||e}async function exportBibTeX(){const e=getPersonalList();if(0===e.length)return void showTemporaryMessage("Sua lista est√° vazia. N√£o h√° nada para exportar.","info");showTemporaryMessage("Buscando dados completos...","info");const t=await fetchCompleteWorkData(e.map(e=>e.id));let a="";a+="%‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n",a+="%                    BIBLIOGRAFIA BIBTEX                        \\n",a+="%                   Ethnos Academic Database                    \\n",a+="%‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n",a+="%\\n",a+=`% Exportado em: ${(new Date).toLocaleDateString("pt-BR")} √†s ${(new Date).toLocaleTimeString("pt-BR")}\\n`,a+=`% Total de refer√™ncias: ${e.length}\\n`,a+=`% Dados completos obtidos: ${t.length}\\n`,a+="% Formato: BibTeX padr√£o para LaTeX\\n",a+="% Fonte: ethnos.app\\n",a+="%\\n",a+="%‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n\\n",e.forEach(n=>{const o=t.find(e=>e.id===n.id)||n;let s="";o.authors&&Array.isArray(o.authors)?s=o.authors.map(e=>{const t=e.name||e.full_name||e,a=t.split(" ");if(a.length>1){return`${a.pop()}, ${a.join(" ")}`}return t}).join(" and "):o.authors&&(s=o.authors.replace(/;/g," and"));const i=(o.title||"").replace(/[{}]/g,""),r=o.subtitle?` - ${o.subtitle}`:"",l=o.publication?.year||o.year||"",c=o.venue?.name||o.venue_name||"",p=o.publication?.volume||o.volume||"",u=o.publication?.issue||o.issue||"",d=o.publication?.pages||o.pages||"",m=o.doi||"",h=o.venue?.issn||"",g=o.publisher?.name||o.publisher_name||"",b=o.language||"",f=o.abstract||"";let _="misc";switch((o.work_type||o.type||"").toUpperCase()){case"ARTICLE":default:_=c?"article":"misc";break;case"BOOK":_="book";break;case"CHAPTER":_="incollection";break;case"CONFERENCE":_="inproceedings";break;case"THESIS":_="phdthesis";break;case"REPORT":_="techreport"}let v=`work${o.id}`;if(o.authors&&Array.isArray(o.authors)&&o.authors[0]){const e=(o.authors[0].name||o.authors[0].full_name||"").split(" ").pop()||"",t=l?l.toString():"nodate";v=`${e.toLowerCase()}${t}work${o.id}`}switch(a+=`% ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Refer√™ncia ${e.indexOf(n)+1}/${e.length} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n`,a+=`@${_}{${v},\\n`,s&&(a+=`  author    = {${s}},\\n`),a+=`  title     = {${i}${r}},\\n`,l&&(a+=`  year      = {${l}},\\n`),_){case"article":c&&(a+=`  journal   = {${c}},\\n`),p&&(a+=`  volume    = {${p}},\\n`),u&&"None"!==u&&(a+=`  number    = {${u}},\\n`),d&&(a+=`  pages     = {${d}},\\n`);break;case"book":g&&(a+=`  publisher = {${g}},\\n`),d&&(a+=`  pages     = {${d}},\\n`);break;case"incollection":c&&(a+=`  booktitle = {${c}},\\n`),g&&(a+=`  publisher = {${g}},\\n`),d&&(a+=`  pages     = {${d}},\\n`);break;case"inproceedings":c&&(a+=`  booktitle = {${c}},\\n`),d&&(a+=`  pages     = {${d}},\\n`);break;case"phdthesis":g&&(a+=`  school    = {${g}},\\n`);break;case"techreport":g&&(a+=`  institution = {${g}},\\n`)}if(m&&(a+=`  doi       = {${m}},\\n`,a+=`  url       = {https://doi.org/${m}},\\n`),h&&(a+=`  issn      = {${h}},\\n`),b&&"pt"!==b&&(a+=`  language  = {${b}},\\n`),f){const e=f.replace(/[{}\\\\]/g,"").substring(0,300);a+=`  abstract  = {${e}${f.length>300?"...":""}},\\n`}const y=[];(o.publication?.open_access||o.open_access)&&y.push("Open Access"),(o.publication?.peer_reviewed||o.peer_reviewed)&&y.push("Peer Reviewed"),y.length>0&&(a+=`  note      = {${y.join(", ")}},\\n`),a+="}\\n\\n"}),a+="%‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n",a+=`% Total de ${e.length} refer√™ncias exportadas\\n`,a+="% Gerado por Ethnos Academic Database (ethnos.app)\\n",a+="% Formato compat√≠vel com LaTeX, BibDesk, Mendeley, Zotero\\n",a+="%‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê",downloadFile(a,`bibliografia-${(new Date).toISOString().split("T")[0]}.bib`,"text/plain"),showTemporaryMessage("Bibliografia BibTeX exportada com formata√ß√£o profissional","success")}async function exportRIS(){const e=getPersonalList();if(0===e.length)return void showTemporaryMessage("Sua lista est√° vazia. N√£o h√° nada para exportar.","info");showTemporaryMessage("Buscando dados completos...","info");const t=await fetchCompleteWorkData(e.map(e=>e.id));let a="";e.forEach(e=>{const n=t.find(t=>t.id===e.id)||e;let o="JOUR";const s=(n.work_type||n.type||"").toUpperCase();switch(s){case"ARTICLE":o="JOUR";break;case"BOOK":o="BOOK";break;case"CHAPTER":o="CHAP";break;case"THESIS":o="THES";break;case"CONFERENCE":o="CONF";break;case"REPORT":o="RPRT";break;case"DATASET":o="DATA";break;default:o=n.venue?.name||n.venue_name?"JOUR":"GEN"}if(a+=`TY  - ${o}\\n`,n.title){const e=n.title+(n.subtitle?` - ${n.subtitle}`:"");a+=`TI  - ${e}\\n`}if(Array.isArray(n.authors)?n.authors.forEach(e=>{const t=e.name||e.full_name||e;t&&(a+=`AU  - ${t}\\n`,e.affiliation&&(a+=`AD  - ${e.affiliation}\\n`),e.orcid&&(a+=`UR  - https://orcid.org/${e.orcid}\\n`))}):n.authors&&(a+=`AU  - ${n.authors}\\n`),n.venue?.name||n.venue_name){const e=n.venue?.name||n.venue_name;a+="JOUR"===o?`JO  - ${e}\\n`:`T2  - ${e}\\n`}const i=n.publication?.year||n.year;i&&(a+=`PY  - ${i}\\n`);const r=n.publication?.volume||n.volume;r&&(a+=`VL  - ${r}\\n`);const l=n.publication?.issue||n.issue;l&&"None"!==l&&(a+=`IS  - ${l}\\n`);const c=n.publication?.pages||n.pages;if(c)if(c.includes("-")){const[e,t]=c.split("-");a+=`SP  - ${e.trim()}\\n`,t&&t.trim()&&(a+=`EP  - ${t.trim()}\\n`)}else a+=`SP  - ${c}\\n`;const p=n.publisher?.name||n.publisher_name;p&&(a+=`PB  - ${p}\\n`);const u=n.doi;u&&(a+=`DO  - ${u}\\n`,a+=`UR  - https://doi.org/${u}\\n`);const d=n.venue?.issn;if(d&&(a+=`SN  - ${d}\\n`),n.abstract){const e=n.abstract.replace(/[\\r\\n\\t]/g," ").substring(0,1e3);a+=`AB  - ${e}${n.abstract.length>1e3?"...":""}\\n`}if(n.language){const e={pt:"por",en:"eng",es:"spa",fr:"fre",de:"ger",it:"ita",Eng:"eng",Ita:"ita",Por:"por"}[n.language]||n.language.toLowerCase();a+=`LA  - ${e}\\n`}const m=[];(n.publication?.peer_reviewed||n.peer_reviewed)&&m.push("peer-reviewed"),(n.publication?.open_access||n.open_access)&&m.push("open-access"),s&&m.push(s.toLowerCase()),m.length>0&&(a+=`KW  - ${m.join(", ")}\\n`),a+="DB  - ethnos_app\\n",a+="DP  - Ethnos Academic Database\\n",a+=`DA  - ${(new Date).toISOString().split("T")[0]}\\n`,a+="ER  - \\n\\n"}),downloadFile(a,`referencias-expandido-${(new Date).toISOString().split("T")[0]}.ris`,"application/x-research-info-systems"),showTemporaryMessage("Bibliografia RIS expandida exportada com sucesso","success")}async function exportJSON(){const e=getPersonalList();if(0===e.length)return void showTemporaryMessage("Sua lista est√° vazia. N√£o h√° nada para exportar.","info");showTemporaryMessage("Buscando dados completos...","info");const t=await fetchCompleteWorkData(e.map(e=>e.id)),a={metadata:{format:"ethnos_json_export",version:"2.1",exported_at:(new Date).toISOString(),generator:"ethnos_app Personal List System",source:"Ethnos Academic Database API v2.0",total_items:e.length,api_calls_successful:t.length,data_quality:t.length===e.length?"complete":"partial"},export_info:{user_list_size:e.length,enhanced_records:t.length,fallback_records:e.length-t.length,data_completeness_ratio:(t.length/e.length*100).toFixed(1)+"%",earliest_added:e.length>0?Math.min(...e.map(e=>new Date(e.added_at||Date.now()).getTime())):null,latest_added:e.length>0?Math.max(...e.map(e=>new Date(e.added_at||0).getTime())):null},works:t.length>0?t.map(a=>{const n=e.find(e=>e.id===a.id);return{id:a.id,title:a.title||"Untitled",subtitle:a.subtitle||null,work_type:a.work_type||a.type||"unknown",language:a.language||null,abstract:a.abstract||null,publication:{year:a.publication?.year||a.year||null,volume:a.publication?.volume||a.volume||null,issue:a.publication?.issue||a.issue||null,pages:a.publication?.pages||a.pages||null,publication_date:a.publication?.publication_date||null,open_access:a.publication?.open_access||a.open_access||!1,peer_reviewed:a.publication?.peer_reviewed||a.peer_reviewed||!1},venue:a.venue?{id:a.venue.id||null,name:a.venue.name||null,type:a.venue.type||null,issn:a.venue.issn||null,eissn:a.venue.eissn||null}:a.venue_name?{name:a.venue_name}:null,publisher:a.publisher?{id:a.publisher.id||null,name:a.publisher.name||null}:a.publisher_name?{name:a.publisher_name}:null,authors:Array.isArray(a.authors)?a.authors.map((e,t)=>({position:t+1,person_id:e.person_id||null,name:e.name||e.full_name||null,given_names:e.given_names||null,family_name:e.family_name||null,orcid:e.orcid||null,affiliation:"string"==typeof e.affiliation?e.affiliation:e.affiliation?.name||null,role:e.role||"AUTHOR"})):"string"==typeof a.authors?[{position:1,name:a.authors,role:"AUTHOR"}]:[],identifiers:{doi:a.doi||null,temp_doi:a.temp_doi||null,pmid:a.identifiers?.find(e=>"PMID"===e.type)?.value||null,arxiv:a.identifiers?.find(e=>"ARXIV"===e.type)?.value||null},metrics:a.metrics?{citation_count:a.metrics.citation_count||0,file_count:a.metrics.file_count||0,has_files:a.metrics.has_files||!1,has_citations:a.metrics.has_citations||!1}:{citation_count:0,file_count:0,has_files:!1,has_citations:!1},user_metadata:{added_to_list_at:n?.added_at||(new Date).toISOString(),export_timestamp:(new Date).toISOString(),data_source:t.find(e=>e.id===a.id)?"api_enhanced":"local_storage"}}}):e.map(e=>({...e,user_metadata:{added_to_list_at:e.added_at||(new Date).toISOString(),export_timestamp:(new Date).toISOString(),data_source:"local_storage_only"}})),statistics:{total_works:e.length,enhanced_from_api:t.length,using_local_data:e.length-t.length,has_abstracts:t.filter(e=>e.abstract&&e.abstract.length>0).length,has_doi:t.filter(e=>e.doi).length,open_access:t.filter(e=>e.publication?.open_access||e.open_access).length,peer_reviewed:t.filter(e=>e.publication?.peer_reviewed||e.peer_reviewed).length}};downloadFile(JSON.stringify(a,null,2),`referencias-expandido-${(new Date).toISOString().split("T")[0]}.json`,"application/json"),showTemporaryMessage("Dados JSON expandidos exportados com sucesso","success")}function downloadFile(e,t,a){const n=new Blob([e],{type:a+";charset=utf-8"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}document.addEventListener("DOMContentLoaded",function(){initializePersonalList()}),window.MyList={loadPersonalList:loadPersonalList,addToPersonalList:addToPersonalList,removeFromList:removeFromList,getPersonalList:getPersonalList,clearAllItems:clearAllItems,updateGlobalCounter:updateGlobalCounter,exportABNT:exportABNT,exportBibTeX:exportBibTeX,exportRIS:exportRIS,exportJSON:exportJSON};