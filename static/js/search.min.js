class SearchHandler{constructor(){this.currentQuery="",this.currentPage=1,this.resultsPerPage=25,this.totalResults=0,this.isLoading=!1,this.autocompleteTimeout=null,this.selectedSuggestionIndex=-1}init(){document.querySelectorAll('form[role="search"]').forEach(e=>{e.addEventListener("submit",t=>{"/results"===window.location.pathname&&(t.preventDefault(),this.handleFormSubmission(e))})}),this.setupAutocomplete(),"/results"===window.location.pathname&&this.handleResultsPage(),this.setupPagination()}setupAutocomplete(){const e=document.getElementById("search-input"),t=document.getElementById("search-ghost");document.getElementById("autocomplete-suggestions");e&&(e.addEventListener("input",e=>{const t=e.target.value.trim();if(clearTimeout(this.autocompleteTimeout),t.length<2)return this.hideAutocomplete(),void this.clearGhost();this.autocompleteTimeout=setTimeout(()=>{this.fetchAutocomplete(t)},200)}),e.addEventListener("keydown",s=>{switch(s.key){case"Tab":case"ArrowRight":t&&t.value&&t.value!==e.value&&(s.preventDefault(),e.value=t.value,this.clearGhost(),this.hideAutocomplete());break;case"Escape":this.hideAutocomplete(),this.clearGhost()}}),document.addEventListener("click",e=>{e.target.closest(".search-input-container")||(this.hideAutocomplete(),this.clearGhost())}))}async fetchAutocomplete(e){const t=document.getElementById("autocomplete-suggestions");try{t&&t.setAttribute("aria-busy","true");const s=await fetch(`/api/autocomplete?q=${encodeURIComponent(e)}&limit=6`),a=await s.json();a.suggestions&&a.suggestions.length>0?this.renderInlineAutocomplete(a.suggestions,e):(this.hideAutocomplete(),this.clearGhost())}catch(e){console.error("Autocomplete error:",e),this.hideAutocomplete(),this.clearGhost()}finally{t&&t.removeAttribute("aria-busy")}}renderInlineAutocomplete(e,t){const s=document.getElementById("search-input"),a=document.getElementById("search-ghost");if(!s||!a||!e.length)return;const n=e.find(e=>e.text.toLowerCase().startsWith(t.toLowerCase()));n&&n.text.toLowerCase()!==t.toLowerCase()?a.value=n.text:this.clearGhost()}clearGhost(){const e=document.getElementById("search-ghost");e&&(e.value="")}renderAutocomplete(e){const t=document.getElementById("autocomplete-suggestions");t&&(t.innerHTML="",e.forEach((e,s)=>{const a=document.createElement("div");a.className="autocomplete-suggestion",a.setAttribute("data-text",e.text),a.setAttribute("data-type",e.type),a.setAttribute("data-index",s.toString());const n=document.createElement("div");n.className="suggestion-text",n.innerHTML=this.highlightQuery(e.text);const o=document.createElement("div");o.className="suggestion-meta";const r=document.createElement("span");if(r.className=`suggestion-type suggestion-type-${e.type}`,r.textContent=this.formatSuggestionType(e.type),o.appendChild(r),e.work_count){const t=document.createTextNode(` ${e.work_count} trabalhos`);o.appendChild(t)}a.appendChild(n),a.appendChild(o),a.addEventListener("click",()=>this.selectSuggestion(a)),t.appendChild(a)}),t.classList.add("active"),this.selectedSuggestionIndex=-1)}highlightQuery(e){const t=document.getElementById("search-input").value.trim();if(!t)return e;const s=new RegExp(`(${t})`,"gi");return e.replace(s,"<strong>$1</strong>")}formatSuggestionType(e){return{title:"Título",venue:"Periódico",author:"Autor"}[e]||e}selectSuggestion(e){const t=e.dataset.text,s=e.dataset.type,a=document.getElementById("search-input");if(a)if(this.hideAutocomplete(),"venue"===s)window.location.href=`/results?venue=${encodeURIComponent(t)}`;else if("author"===s)window.location.href=`/results?author=${encodeURIComponent(t)}`;else{a.value=t;const e=document.getElementById("search-form");e&&e.submit()}}updateSuggestionHighlight(){document.querySelectorAll(".autocomplete-suggestion").forEach((e,t)=>{e.classList.toggle("highlighted",t===this.selectedSuggestionIndex)})}hideAutocomplete(){const e=document.getElementById("autocomplete-suggestions");e&&(e.classList.remove("active"),e.innerHTML="",e.style.display="none"),this.selectedSuggestionIndex=-1}handleFormSubmission(e){const t=new FormData(e),s=this.buildSearchParams(t);if(s.q||this.hasAdvancedParams(t)){const e=new URLSearchParams(s).toString();window.history.pushState({},"","/results?"+e),this.performSearch(s),this.hideAutocomplete()}else this.showError("Preencha pelo menos um campo de busca.")}buildSearchParams(e){let t={};return e.get("q")&&(t.q=e.get("q").trim()),["title","author","abstract","subject","venue","publisher","type","language"].forEach(s=>{e.get(s)&&(t[s]=e.get(s).trim())}),e.get("year_start")&&(t.year_start=e.get("year_start")),e.get("year_end")&&(t.year_end=e.get("year_end")),e.get("sort")&&(t.sort=e.get("sort")),t.limit=this.resultsPerPage,t}hasAdvancedParams(e){return["title","author","abstract","subject","venue","publisher"].some(t=>e.get(t))}handleResultsPage(){const e=new URLSearchParams(window.location.search);if(e.has("q")||this.hasAdvancedUrlParams(e)){const t=Object.fromEntries(e.entries());this.performSearch(t)}}hasAdvancedUrlParams(e){return["title","author","abstract","subject","venue","publisher"].some(t=>e.has(t))}async performSearch(e){if(!this.isLoading){this.isLoading=!0,this.showLoading();try{const t=await fetch("/api/v1/works/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({params:e})}),s=await t.json();this.displayResults(s,e),this.currentQuery=e.q||"Busca Avançada",this.totalResults=s.total||0}catch(e){console.error("Search error:",e),this.showError("Erro ao realizar busca. Tente novamente.")}finally{this.isLoading=!1}}}displayResults(e,t){const s=document.querySelector(".results-container")||document.querySelector('section[aria-labelledby="search-results"]');s?(this.updateSearchHeader(t,e.total),e.data&&e.data.length>0?(this.renderSortControls(s,t),this.renderResults(e.data,s),e.pagination&&this.renderPagination(e,s)):this.renderNoResults(t.q,s)):console.error("Results container not found")}renderResults(e,t){const s=e.map(e=>{const t=e.relevance_score?`<span class="relevance-score">Score: ${e.relevance_score}</span>`:"",s=e.peer_reviewed?'<span class="badge peer-reviewed">Revisado por Pares</span>':"";return`\n                <article class="result-item">\n                    <h3 class="result-title">\n                        <a href="/work/${e.id}" class="result-link">\n                            ${e.title||"Título não disponível"}\n                            ${e.subtitle?" - "+e.subtitle:""}\n                        </a>\n                        ${t}\n                    </h3>\n                    \n                    <div class="result-meta">\n                        <span class="result-authors">${e.formatted_authors||e.author_string||"Autor não informado"}</span>\n                        ${e.publication_year||e.year?`<span class="result-year"> • ${e.publication_year||e.year}</span>`:""}\n                        ${e.work_type?`<span class="result-type"> • ${this.formatWorkType(e.work_type)}</span>`:""}\n                        ${e.language?`<span class="result-language"> • ${this.formatLanguage(e.language)}</span>`:""}\n                        ${s}\n                    </div>\n                    \n                    ${e.venue_name?`\n                        <div class="result-venue">\n                            <strong>Publicado em:</strong> ${e.venue_name}\n                        </div>\n                    `:""}\n                    \n                    ${e.doi?`\n                        <div class="result-doi">\n                            <strong>DOI:</strong> <a href="https://doi.org/${e.doi}" target="_blank" rel="noopener">${e.doi}</a>\n                        </div>\n                    `:""}\n                    \n                    ${e.abstract?`\n                        <div class="result-abstract">\n                            <p>${e.abstract.substring(0,300)}${e.abstract.length>300?"...":""}</p>\n                        </div>\n                    `:""}\n\n                    <div class="result-actions">\n                        <a href="/work/${e.id}" class="action-btn btn-positive">Ver Detalhes</a>\n                        ${e.doi?`<a href="https://doi.org/${e.doi}" target="_blank" rel="noopener" class="action-btn">Acesso Direto</a>`:""}\n                    </div>\n                </article>\n            `}).join("");t.innerHTML=`<div class="results-container">${s}</div>`}formatWorkType(e){return{ARTICLE:"Artigo",BOOK:"Livro",CHAPTER:"Capítulo",THESIS:"Tese/Dissertação",CONFERENCE:"Artigo de Evento",REPORT:"Relatório",DATASET:"Dataset",OTHER:"Outro"}[e]||e}formatLanguage(e){return{pt:"Português",en:"Inglês",es:"Espanhol",fr:"Francês",de:"Alemão",it:"Italiano"}[e]||e}renderNoResults(e,t){const s=e&&"Busca Avançada"!==e?`\n            <div class="no-results">\n                <p>Nenhum resultado encontrado para "<strong>${e}</strong>".</p>\n                <p>Tente usar termos diferentes ou verifique a ortografia.</p>\n            </div>\n        `:'\n            <div class="info-message">\n                <p>Preencha pelo menos um campo de busca para ver os resultados.</p>\n            </div>\n        ';t.innerHTML=s}updateSearchHeader(e,t){const s=document.querySelector(".page-header");if(!s)return;const a=e.q||"Busca Avançada";let n=s.querySelector(".search-summary")||document.createElement("p"),o=s.querySelector(".search-stats")||document.createElement("p");n.className="search-summary",n.innerHTML=`Resultados para: "<strong>${a}</strong>"`,o.className="search-stats",o.innerHTML=t.toLocaleString("pt-BR")+" resultados encontrados",s.querySelector(".search-summary")||s.appendChild(n),s.querySelector(".search-stats")||s.appendChild(o)}renderPagination(e,t){if(!e.pagination||e.pagination.totalPages<=1)return;const{page:s,totalPages:a}=e.pagination,n=`\n            <nav class="pagination-nav" aria-label="Navegação de páginas de resultados">\n                <button class="action-btn pagination-btn" ${s<=1?"disabled":""} \n                        onclick="searchHandler.goToPage(${s-1})" aria-label="Página anterior">\n                    « Anterior\n                </button>\n                <span class="pagination-info">Página ${s} de ${a}</span>\n                <button class="action-btn pagination-btn" ${s>=a?"disabled":""} \n                        onclick="searchHandler.goToPage(${s+1})" aria-label="Próxima página">\n                    Próximo »\n                </button>\n            </nav>\n        `;t.querySelector(".results-container").insertAdjacentHTML("afterend",n)}goToPage(e){if(e<1||this.isLoading)return;this.currentPage=e;const t=new URLSearchParams(window.location.search),s=Object.fromEntries(t.entries());s.page=e;const a="/results?"+new URLSearchParams(s).toString();window.history.pushState({},"",a),this.performSearch(s)}setupPagination(){window.addEventListener("popstate",()=>{"/results"===window.location.pathname&&this.handleResultsPage()})}showLoading(){const e=document.querySelector('section[aria-labelledby="search-results"]');e&&(e.innerHTML='<p class="field-value">Realizando busca...</p>')}showError(e){const t=document.querySelector('section[aria-labelledby="search-results"]');t&&(t.innerHTML=`<div class="error-message"><p>${e}</p></div>`)}}document.addEventListener("DOMContentLoaded",function(){window.searchHandler=new SearchHandler,window.searchHandler.init()});